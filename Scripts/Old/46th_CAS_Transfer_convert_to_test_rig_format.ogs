// This script is used in transfer curves taken with the CAS setup. It transforms the format of the workbook in the familiar format, as exported by the LabVIEW frontend of the testing rigs.

[Main]

string sheetname;

doc -ef LB { // loop over all workbooks in folder
	wks.colwidth = 9;// set all col width to 9
	//sheetname$=wks.longname$; //get the name of worksheet
	//%A=sheetname.GetToken(9,"_")$; // get the string "T" or "O", which shows if the curve is a transfer or output curve
	page.title = 1;  // Let the workbook title shows Long Name only (1 = Long Name, 2 = short name, 3 = both)
	

if(exist(%H,2)==0) //not a workbook, must be a matrix
		continue;
	else 
		if (%A == "O") continue;	// if this is an output curve then break
			else wks.ncols=6; // set total column number to 6
				range rap = [%H];
				wrcopy iw:=%(rap)! r1:=143 r2:=284 c1:=3 c2:=4 ow:=%(rap) dr1:=1 dc1:=5; 
				// Write long name, units, comments, and parameter1 of column B
				col(A) = col(B); // Copy Vg data to column A
				col(A)[L]$ = "Vg"; // Long name
				col(A)[U]$ = V; // Units
				
				col(B) = col(D); // Copy Id (Vg=-5.0V) data to column B
				col(B)[L]$ = "Id (Vd=-5.0V)"; // Long name
				col(B)[U]$ = A; // Units
				
				col(D) = col(C); // Copy contents of col(C) to col(D). This is Ig (Vd=-5.0V)
				col(D)[L]$ = "Ig (Vd=-5.0V)"; // Long name
				col(D)[U]$ = A; // Units
				
				col(C) = col(F); // Copy Id (Vg=-50.0V) data to column B
				col(C)[L]$ = "Id (Vd=-50.0V)"; // Long name
				col(C)[U]$ = A; // Units
				
				col(E)[L]$ = "Ig (Vd=-50.0V)"; // Long name
				col(E)[U]$ = A; // Units

				wks.ncols=5;
				wks.nrows=142;
}

doc -ef LB { // loop over all workbooks in folder
	page.title = 1;  // Let the workbook title shows Long Name only (1 = Long Name, 2 = short name, 3 = both)
	

if(exist(%H,2)==0) continue; //not a workbook, must be a matrix
			else wks.ncols=9; // set total column number to 9
				// Write long name, units, comments, and parameter1 of column B
				col(F)[L]$ = "Id (Vd=-5.0V) /A"; // Long name
				col(F)[U]$ = A; // Units
				col(F)[O]$="abs(col(B))";
				
				col(G)[L]$ = "Id (Vd=-50.0V) /A"; // Long name
				col(G)[U]$ = A; // Units
				col(G)[O]$="abs(col(C))";
								
				col(H)[L]$ = "Ig (Vd=-5.0V) /A"; // Long name
				col(H)[U]$ = A; // Units
				col(H)[O]$="abs(col(D))";
								
				col(I)[L]$ = "Ig (Vd=-50.0V) /A"; // Long name
				col(I)[U]$ = A; // Units
				col(I)[O]$="abs(col(E))";
}